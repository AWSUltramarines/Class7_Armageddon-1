# Global Edge & Origin-Driven Architecture

## High-Level Architecture

This deployment utilizes a "Secure Origin" pattern, where a global Content Delivery Network (CloudFront) serves as the only entry point for users, communicating with an Application Load Balancer (ALB) via a verified secret header.

### **Core Infrastructure Pillars**

1. **Global Edge (CloudFront & WAF)**: Manages caching and security at the edge.
2. **Regional Entry (ALB)**: Handles SSL termination and traffic routing via SNI for `daequanbritt.com`.
3. **Compute Layer (EC2 & Flask)**: A private web server running a Python-based REST API.
4. **Storage Layer (RDS MySQL)**: An isolated database for persistent data storage.

---

## Detailed Component Breakdown

### **1. Identity & Security (The "Shield")**

* **WAF Integration**: A Global WAF protects the CloudFront edge, while a Regional WAF protects the ALB from direct-to-IP attacks.
* **Secret Origin Header**: The ALB is "cloaked." It only accepts traffic containing a `X-Custom-Header` generated by a `random_password` resource in Terraform.
* **SSL/TLS SNI**: The ALB uses Server Name Indication (SNI) to host multiple certificates, resolving handshake issues for the Apex domain.

### **2. Networking & Privacy**

* **VPC Design**: Architecture spans multiple Availability Zones (AZs) for high availability.
* **Isolated Subnets**: The EC2 instance and RDS database reside in private subnets with no public IP addresses. Outbound traffic is handled via a NAT Gateway.
* **Security Groups**: A tiered security model ensures that the Database only accepts traffic from the Web Server, and the Web Server only accepts traffic from the ALB.

### **3. Honors Caching Logic (Origin-Driven)**

The deployment uses a sophisticated "Policy-Based" caching model implemented in `12-cache.tf` and `10-cloudfront.tf`.

| Feature | Behavior | Implementation |
| --- | --- | --- |
| **Static Assets** | Aggressive Caching | 1-year TTL via `Response Headers Policy`. |
| **Public API** | Origin-Driven | Respects `s-maxage=30` from the Flask application. |
| **Private Data** | No-Store | Explicitly bypasses cache via `private, no-store` headers. |

---

## Deployment & Verification

### **Infrastructure Deployment**

```bash
terraform init
terraform apply -replace="aws_instance.web_server"

```

### **Verification Commands**

* **The Safety Proof (API List)**:
`curl -I https://daequanbritt.com/api/list`
*Result: `x-cache: Miss`, `Cache-Control: private, no-store*`
* **The Honors Proof (Public Feed)**:
`curl -I https://daequanbritt.com/api/public-feed`
*Result: `x-cache: Hit` (after first request), `Age: > 0*`

---

## Why Origin-Driven?

This deployment demonstrates high level engineering by delegating TTL authority to the application. This ensures that the infrastructure remains flexible; if a developer needs to change the data freshness window, they simply update the Python header without requiring a full Terraform redeploy. This significantly reduces the risk of data leakage for private endpoints while maximizing global performance for public feeds.

## Key Changes Summary
```diff
- removed old `aws_cloudfront_distribution.main` `ordered_cache_behavior` in 10-cloudfront.tf
+ added new `aws_cloudfront_distribution.main` `ordered_cache_behavior` in 10-cloudfront.tf

- removed old `@app.route("/list") from 1a_user_data_tf.sh
+ added `@app.route("/api/public-feed")` & `@app.route("/api/list")` to `1a_user_data_tf.sh`

+ added line 15 in `1a_user_data_tf.sh` to import date and time

+ modified line 14 in `1a_user_data_tf.sh` import jsonify & make_response
```

## File Tree:
```bash
.
├── 00-auth.tf          # Multi-Region Providers (Ohio & N. Virginia) & S3 Backend 
├── 01-IAM.tf           # EC2 Role with scoped Secrets/SSM & CloudWatch permissions
├── 02-secrets.tf       # DB Credentials & Global Origin-Header secret generation
├── 03-network.tf       # VPC, Multi-AZ Subnets, NAT GW, & PrivateLink Endpoints
├── 04-sg.tf            # ALB Cloaking via CloudFront Prefix List & SG-to-SG rules 
├── 05-main.tf          # Private EC2 Web Server & RDS MySQL Instance (Isolated)
├── 06-logging.tf       # SNS, Metric Filters, & S3 Bucket for ALB Access Logs
├── 07-alb-dns.tf       # ALB Listeners, SNI Cert Bindings (Apex Fix), & Header-Check Rules 
├── 08-dashboard.tf     # CloudWatch Dashboard for CPU, Latency, & 5xx Monitoring
├── 09-waf.tf           # Regional WAF (ALB) & Global WAF (CloudFront) 
├── 10-cloudfront.tf    # CDN Distribution with Policy-Based Behaviors (Static vs. API)
├── 11-cert.tf          # N. Virginia (us-east-1) ACM Certificate for Global Edge
├── 12-cache.tf         # Cache Policies, Updated Origin Request Policies, & Response Headers
├── 1a_user_data_tf.sh  # Updated Flask App script with CloudWatch logging & RDS logic
├── 98-outputs.tf       # Global App URLs, ALB DNS, and Sensitive Origin Header Secrets
├── 99-variables.tf     # Variable definitions for Project, Domain, & WAF settings
└── terraform.tfvars    # Environment values & Alert Email configurations
```